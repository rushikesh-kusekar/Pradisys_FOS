[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "FOS Day Plan",
  "enabled": 0,
  "modified": "2025-12-10 22:10:27.165114",
  "module": null,
  "name": "FOS Day Plan Naming",
  "script": "frappe.ui.form.on('FOS Day Plan', {\r\n  before_save: function(frm) {\r\n    const agent = (frm.doc.agent || frm.doc.agent_name || '').trim();\r\n    const plan_date = frm.doc.plan_date;\r\n\r\n    if (!agent || !plan_date) {\r\n      // Nothing to do â€” you may choose to block save if required\r\n      return;\r\n    }\r\n\r\n    // plan_date is by default \"YYYY-MM-DD\"\r\n    const name_value = agent + '_' + plan_date;\r\n    frm.set_value('full_name_for_doc', name_value);\r\n  }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "FOS Cash Deposit",
  "enabled": 0,
  "modified": "2025-12-10 22:01:49.602043",
  "module": null,
  "name": "FOS Cash Deposit Collection Auto",
  "script": "// FOS Cash Deposit â€“ load undeposited collections for selected Day Plan\r\n\r\nfrappe.ui.form.on('FOS Cash Deposit', {\r\n  day_plan(frm) {\r\n    if (!frm.doc.day_plan) {\r\n      return;\r\n    }\r\n\r\n    // Optional: set FOS Agent from the Day Plan\r\n    frappe.call({\r\n      method: 'frappe.client.get',\r\n      args: {\r\n        doctype: 'FOS Day Plan',\r\n        name: frm.doc.day_plan,\r\n      },\r\n      callback(dp) {\r\n        if (dp.message && dp.message.agent && !frm.doc.fos_agent) {\r\n          frm.set_value('fos_agent', dp.message.agent);\r\n        }\r\n      },\r\n    });\r\n\r\n    load_collections_for_day_plan(frm);\r\n  },\r\n});\r\n\r\nfunction load_collections_for_day_plan(frm) {\r\n  // If table already has rows, confirm before replacing\r\n  if ((frm.doc.collections || []).length) {\r\n    frappe.confirm(\r\n      __('Replace existing rows with all undeposited collections for this Day Plan?'),\r\n      () => _fetch_and_set_rows(frm)\r\n    );\r\n  } else {\r\n    _fetch_and_set_rows(frm);\r\n  }\r\n}\r\n\r\nfunction _fetch_and_set_rows(frm) {\r\n  frappe.call({\r\n    method: 'frappe.client.get_list',\r\n    args: {\r\n      doctype: 'FOS Collection',\r\n      filters: {\r\n        day_plan: frm.doc.day_plan,\r\n        is_deposited: 0,                 // only not-yet-deposited collections\r\n        // Optional: also match agent\r\n        // fos_agent: frm.doc.fos_agent || undefined,\r\n      },\r\n      fields: ['name', 'amount'],\r\n      limit_page_length: 500,\r\n    },\r\n    callback(r) {\r\n      const cols = r.message || [];\r\n      frm.clear_table('collections');\r\n\r\n      let total = 0;\r\n      cols.forEach((c) => {\r\n        const row = frm.add_child('collections');\r\n        row.collection = c.name;\r\n        row.amount = c.amount;\r\n        total += parseFloat(c.amount || 0);\r\n      });\r\n\r\n      frm.refresh_field('collections');\r\n\r\n      // Set Amount Deposited = sum of all collection amounts\r\n      frm.set_value('amount_deposited', total);\r\n\r\n    //   frappe.msgprint(\r\n    //     __(\r\n    //       'Loaded {0} collections for this Day Plan. Total amount: {1}',\r\n    //       [cols.length, total]\r\n    //     )\r\n    //   );\r\n    },\r\n  });\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "FOS Day Plan",
  "enabled": 0,
  "modified": "2025-12-10 17:02:46.813092",
  "module": null,
  "name": "FOS Day Plan Item Assig",
  "script": "// Client Script: FOS Day Plan\r\n\r\nfrappe.ui.form.on('FOS Day Plan', {\r\n  onload(frm) {\r\n    const table_fieldname = 'day_plan_items';\r\n\r\n    if (!frm.fields_dict[table_fieldname]) return;\r\n\r\n    // ðŸ”¹ Filter \"Case\" field inside child table\r\n    frm.set_query('case', table_fieldname, function (doc, cdt, cdn) {\r\n      if (!doc.region) {\r\n        frappe.msgprint(__('Please set Region first.'));\r\n      }\r\n\r\n      return {\r\n        filters: [\r\n          ['FOS Case', 'region', '=', doc.region || ''],\r\n          ['FOS Case', 'status', 'in', ['Open', 'Pending']],\r\n          ['FOS Case', 'is_in_day_plan', '=', 0], // not already in day plan\r\n        ],\r\n      };\r\n    });\r\n  },\r\n\r\n  refresh(frm) {\r\n    calculate_total_planned_amount(frm);\r\n  },\r\n\r\n  day_plan_items_add(frm) {\r\n    calculate_total_planned_amount(frm);\r\n  },\r\n\r\n  day_plan_items_remove(frm) {\r\n    calculate_total_planned_amount(frm);\r\n  },\r\n\r\n  // ðŸ”¹ When Region changes â†’ filter agents + auto-fill cases\r\n  region(frm) {\r\n    filter_agents_by_region(frm);\r\n    auto_fill_cases(frm);\r\n  },\r\n\r\n  // ðŸ”¹ When Agent changes â†’ auto-fill cases\r\n  agent(frm) {\r\n    auto_fill_cases(frm);\r\n  },\r\n});\r\n\r\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n// NEW FUNCTION â€“ Filter Agents by Region\r\n// (Fixed: removed enabled filter causing error)\r\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n\r\nfunction filter_agents_by_region(frm) {\r\n  if (!frm.doc.region) return;\r\n\r\n  frm.set_query('agent', function () {\r\n    return {\r\n      filters: {\r\n        region: frm.doc.region,  // only show agents of this region\r\n      },\r\n    };\r\n  });\r\n\r\n // frappe.msgprint(__('Agent list updated for Region {0}', [frm.doc.region]));\r\n}\r\n\r\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n// Auto-fill Cases for Region + Agent\r\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n\r\nfunction auto_fill_cases(frm) {\r\n  if (frm.doc.docstatus !== 0) return;\r\n\r\n  if (!frm.doc.agent || !frm.doc.region) {\r\n    return;\r\n  }\r\n\r\n  if ((frm.doc.day_plan_items || []).length) {\r\n    frappe.confirm(\r\n      __(\r\n        'Load all open cases for Region {0}? Existing rows will be replaced.',\r\n        [frm.doc.region]\r\n      ),\r\n      () => fetch_and_set_cases(frm)\r\n    );\r\n  } else {\r\n    fetch_and_set_cases(frm);\r\n  }\r\n}\r\n\r\nfunction fetch_and_set_cases(frm) {\r\n  frappe.call({\r\n    method: 'frappe.client.get_list',\r\n    args: {\r\n      doctype: 'FOS Case',\r\n      filters: {\r\n        region: frm.doc.region,\r\n        status: ['in', ['Open', 'Pending']],\r\n        is_in_day_plan: 0,\r\n      },\r\n      fields: [\r\n        'name',\r\n        'fos_customer',\r\n        'status',\r\n        'overdue_amt',\r\n        'pending_amount',\r\n      ],\r\n      limit_page_length: 500,\r\n    },\r\n    callback(r) {\r\n      const cases = r.message || [];\r\n\r\n      frm.clear_table('day_plan_items');\r\n\r\n      cases.forEach((c) => {\r\n        const row = frm.add_child('day_plan_items');\r\n        row.case = c.name;\r\n        row.customer = c.fos_customer;\r\n        row.status = c.status;\r\n        row.overdue_amount = c.overdue_amt;\r\n        row.pending_amount = c.pending_amount;\r\n      });\r\n\r\n      frm.refresh_field('day_plan_items');\r\n      calculate_total_planned_amount(frm);\r\n\r\n      //frappe.msgprint(__('Loaded {0} cases.', [cases.length]));\r\n    },\r\n  });\r\n}\r\n\r\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n// Helper Functions\r\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n\r\nfunction to_number(val) {\r\n  if (!val) return 0;\r\n  if (typeof val === 'number') return val;\r\n\r\n  if (typeof val === 'string') {\r\n    const cleaned = val.replace(/[^\\d.-]/g, '');\r\n    if (!cleaned) return 0;\r\n    const n = parseFloat(cleaned);\r\n    return isNaN(n) ? 0 : n;\r\n  }\r\n\r\n  return 0;\r\n}\r\n\r\nfunction calculate_total_planned_amount(frm) {\r\n  let total = 0;\r\n\r\n  (frm.doc.day_plan_items || []).forEach((row) => {\r\n    const pending = to_number(\r\n      row.pending_amount || row.pending_amt || row.pending\r\n    );\r\n    const overdue = to_number(\r\n      row.overdue_amount || row.overdue_amt || row.overdue\r\n    );\r\n\r\n    const row_value = pending > 0 ? pending : overdue;\r\n    total += row_value;\r\n  });\r\n\r\n  frm.set_value('total_planned_amount', total);\r\n  frm.refresh_field('total_planned_amount');\r\n}\r\n\n\nfrappe.ui.form.on('FOS Day Plan Item', {\n\trefresh(frm) {\n\t\t// your code here\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "FOS Case",
  "enabled": 0,
  "modified": "2025-12-10 21:50:44.069132",
  "module": null,
  "name": "FOS Case TrackTime",
  "script": "// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n// FOS Case â€“ Start/End GPS + Route Line on Map\r\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n\r\nfrappe.ui.form.on(\"FOS Case\", {\r\n    start_day(frm) {\r\n        capture_location(frm, \"start\");\r\n    },\r\n\r\n    end_day(frm) {\r\n        capture_location(frm, \"end\");\r\n    },\r\n\r\n    refresh(frm) {\r\n        render_map(frm);\r\n    }\r\n});\r\n\r\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n// Capture Live Location (Start / End)\r\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n\r\nfunction capture_location(frm, mode) {\r\n    if (!navigator.geolocation) {\r\n        frappe.msgprint(\"Geolocation is not supported by your browser.\");\r\n        return;\r\n    }\r\n\r\n    frappe.dom.freeze(\"Fetching live locationâ€¦\");\r\n\r\n    navigator.geolocation.getCurrentPosition(\r\n        (pos) => {\r\n            frappe.dom.unfreeze();\r\n\r\n            const { latitude, longitude } = pos.coords;\r\n\r\n            if (mode === \"start\") {\r\n                frm.set_value(\"day_start_time\", frappe.datetime.now_datetime());\r\n                frm.set_value(\"start_latitude\", latitude);\r\n                frm.set_value(\"start_longitude\", longitude);\r\n            } else {\r\n                frm.set_value(\"day_end_time\", frappe.datetime.now_datetime());\r\n                frm.set_value(\"end_latitude\", latitude);\r\n                frm.set_value(\"end_longitude\", longitude);\r\n            }\r\n\r\n            frm.save().then(() => {\r\n                frappe.show_alert({\r\n                    message: `${mode.toUpperCase()} Location Saved: ${latitude.toFixed(5)}, ${longitude.toFixed(5)}`,\r\n                    indicator: \"green\",\r\n                });\r\n\r\n                render_map(frm);\r\n            });\r\n        },\r\n        (err) => {\r\n            frappe.dom.unfreeze();\r\n            frappe.msgprint(\"âŒ Unable to get GPS location: \" + err.message);\r\n        },\r\n        {\r\n            enableHighAccuracy: true,\r\n            timeout: 10000,\r\n        }\r\n    );\r\n}\r\n\r\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n// Render Map â€“ Add Start Marker, End Marker, Route Line\r\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n\r\nfunction render_map(frm) {\r\n    const mapfield = frm.get_field(\"geolocation\");\r\n\r\n    if (!mapfield || !mapfield.map) return;\r\n\r\n    const map = mapfield.map;\r\n\r\n    // Coordinates\r\n    const start_lat = frm.doc.start_latitude;\r\n    const start_lng = frm.doc.start_longitude;\r\n    const end_lat = frm.doc.end_latitude;\r\n    const end_lng = frm.doc.end_longitude;\r\n\r\n    // Clear old markers & polylines\r\n    map.eachLayer((layer) => {\r\n        if (layer instanceof L.Marker || layer instanceof L.Polyline) {\r\n            map.removeLayer(layer);\r\n        }\r\n    });\r\n\r\n    let markers = [];\r\n\r\n    // --- START Marker ---\r\n    if (start_lat && start_lng) {\r\n        const startMarker = L.marker([start_lat, start_lng])\r\n            .addTo(map)\r\n            .bindPopup(\"ðŸ“ Start Location\")\r\n            .openPopup();\r\n\r\n        markers.push(startMarker);\r\n    }\r\n\r\n    // --- END Marker ---\r\n    if (end_lat && end_lng) {\r\n        const endMarker = L.marker([end_lat, end_lng])\r\n            .addTo(map)\r\n            .bindPopup(\"ðŸ End Location\");\r\n\r\n        markers.push(endMarker);\r\n    }\r\n\r\n    // --- ROUTE LINE (Start â†’ End) ---\r\n    if (start_lat && start_lng && end_lat && end_lng) {\r\n        const routeLine = L.polyline(\r\n            [\r\n                [start_lat, start_lng],\r\n                [end_lat, end_lng],\r\n            ],\r\n            {\r\n                color: \"red\",\r\n                weight: 4,\r\n                opacity: 0.8,\r\n            }\r\n        ).addTo(map);\r\n\r\n        markers.push(routeLine);\r\n\r\n        // Fit map to show whole route\r\n        map.fitBounds(routeLine.getBounds(), { padding: [20, 20] });\r\n        return;\r\n    }\r\n\r\n    // If only one marker exists â†’ center on it\r\n    if (markers.length === 1) {\r\n        map.setView(markers[0].getLatLng(), 15);\r\n    }\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "FOS Case",
  "enabled": 0,
  "modified": "2025-12-10 21:45:09.400007",
  "module": null,
  "name": "FOS Case To Collection",
  "script": "// FOS Case â€“ Start Collection button (minimal debug version)\r\nfrappe.ui.form.on(\"FOS Case\", {\r\n  start_collection(frm) {\r\n    // ðŸ” Debug: make sure this handler is firing\r\n    console.log(\"Start Collection button clicked\");\r\n    // frappe.msgprint(\"Start Collection button clicked\");\r\n\r\n    if (!frm.doc.name) {\r\n      frappe.msgprint(__(\"Please save the Case first.\"));\r\n      return;\r\n    }\r\n\r\n    // Pre-fill values for FOS Collection\r\n    frappe.route_options = {\r\n      case: frm.doc.name,\r\n      customer: frm.doc.fos_customer || frm.doc.customer || \"\",\r\n      fos_agent: frm.doc.agent || frm.doc.fos_agent || \"\",\r\n      day_plan: frm.doc.day_plan || \"\",\r\n      collection_datetime: frappe.datetime.now_datetime(),\r\n    };\r\n\r\n    // ðŸš€ Open New FOS Collection form\r\n    frappe.new_doc(\"FOS Collection\");\r\n  },\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "FOS Day Plan",
  "enabled": 0,
  "modified": "2025-12-10 19:18:10.709028",
  "module": null,
  "name": "FOS Day Plan Details",
  "script": "// FOS Day Plan Item events\r\nfrappe.ui.form.on(\"FOS Day Plan Item\", {\r\n  // 1) When user selects a Case in the row\r\n  case(frm, cdt, cdn) {\r\n    const row = locals[cdt][cdn];\r\n\r\n    if (!row.case) return;\r\n\r\n    frappe.call({\r\n      method: \"frappe.client.get\",\r\n      args: {\r\n        doctype: \"FOS Case\",\r\n        name: row.case,\r\n      },\r\n      callback(r) {\r\n        if (!r.message) return;\r\n        const d = r.message;\r\n\r\n        // Fill row values from FOS Case\r\n        frappe.model.set_value(cdt, cdn, \"customer\", d.fos_customer || \"\");\r\n        frappe.model.set_value(cdt, cdn, \"address\", d.current_address || \"\");\r\n\r\n        // -------------- AUTO-SET FOS AGENT ON HEADER --------------\r\n        if (d.fos_agent) {\r\n          frm.set_value(\"fos_agent\", d.fos_agent);\r\n        }\r\n      },\r\n    });\r\n  },\r\n\r\n  // 2) Details button â€“ directly open the Case form (NO popup)\r\n  details(frm, cdt, cdn) {\r\n    const row = locals[cdt][cdn];\r\n\r\n    if (!row.case) {\r\n      frappe.msgprint(\"Please select a Case first.\");\r\n      return;\r\n    }\r\n\r\n    // ðŸ”¹ Direct navigation to that FOS Case\r\n    frappe.set_route(\"Form\", \"FOS Case\", row.case);\r\n  },\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "FOS Day Plan",
  "enabled": 0,
  "modified": "2025-12-10 19:13:55.686050",
  "module": null,
  "name": "FOS Day Plan Start/End Time",
  "script": "// FOS Day Plan â€“ Time + GPS using form buttons Start Day / End Day\r\n\r\nfrappe.ui.form.on('FOS Day Plan', {\r\n  // Called when Start Day button (fieldname = start_day) is clicked\r\n  start_day(frm) {\r\n    start_day_with_location(frm);\r\n  },\r\n\r\n  // Called when End Day button (fieldname = end_day) is clicked\r\n  end_day(frm) {\r\n    end_day_with_location(frm);\r\n  },\r\n});\r\n\r\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n// Helpers\r\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n\r\nfunction start_day_with_location(frm) {\r\n  if (!navigator.geolocation) {\r\n    frappe.msgprint(__('Geolocation is not supported by this browser.'));\r\n    return;\r\n  }\r\n\r\n  frappe.dom.freeze(__('Getting your location...'));\r\n\r\n  navigator.geolocation.getCurrentPosition(\r\n    (pos) => {\r\n      frappe.dom.unfreeze();\r\n\r\n      const { latitude, longitude } = pos.coords;\r\n\r\n      // Set time + location\r\n      frm.set_value('day_start_time', frappe.datetime.now_datetime());\r\n      frm.set_value('start_latitude', latitude);\r\n      frm.set_value('start_longitude', longitude);\r\n\r\n      // Optional: update status (make sure option exists)\r\n      // frm.set_value('status', 'In Progress');\r\n\r\n      frm.save().then(() => {\r\n        frappe.msgprint(\r\n          __('Day started at {0}, {1}', [\r\n            latitude.toFixed(6),\r\n            longitude.toFixed(6),\r\n          ])\r\n        );\r\n      });\r\n    },\r\n    (err) => {\r\n      frappe.dom.unfreeze();\r\n      frappe.msgprint(__('Could not get location: {0}', [err.message]));\r\n    },\r\n    {\r\n      enableHighAccuracy: true,\r\n      timeout: 10000,\r\n    }\r\n  );\r\n}\r\n\r\nfunction end_day_with_location(frm) {\r\n  if (!navigator.geolocation) {\r\n    frappe.msgprint(__('Geolocation is not supported by this browser.'));\r\n    return;\r\n  }\r\n\r\n  frappe.dom.freeze(__('Getting your location...'));\r\n\r\n  navigator.geolocation.getCurrentPosition(\r\n    (pos) => {\r\n      frappe.dom.unfreeze();\r\n\r\n      const { latitude, longitude } = pos.coords;\r\n\r\n      // Set time + location\r\n      frm.set_value('day_end_time', frappe.datetime.now_datetime());\r\n      frm.set_value('end_latitude', latitude);\r\n      frm.set_value('end_longitude', longitude);\r\n\r\n      // Optional: update status (make sure option exists)\r\n      // frm.set_value('status', 'Completed');\r\n\r\n      frm.save().then(() => {\r\n        frappe.msgprint(\r\n          __('Day ended at {0}, {1}', [\r\n            latitude.toFixed(6),\r\n            longitude.toFixed(6),\r\n          ])\r\n        );\r\n      });\r\n    },\r\n    (err) => {\r\n      frappe.dom.unfreeze();\r\n      frappe.msgprint(__('Could not get location: {0}', [err.message]));\r\n    },\r\n    {\r\n      enableHighAccuracy: true,\r\n      timeout: 10000,\r\n    }\r\n  );\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "FOS Day Plan",
  "enabled": 0,
  "modified": "2025-12-10 19:05:06.633702",
  "module": null,
  "name": "FOS Day Plan Create Collection",
  "script": "frappe.ui.form.on('FOS Day Plan Item', {\r\n  create_collection: function (frm, cdt, cdn) {\r\n    const row = locals[cdt][cdn];\r\n\r\n    // safety checks\r\n    if (!row.case) {\r\n      frappe.msgprint(__('Please select a Case first.'));\r\n      return;\r\n    }\r\n\r\n    // ðŸ§  Parent + Row data â†’ FOS Collection\r\n    frappe.route_options = {\r\n      // parent agent field (change 'agent' if your fieldname is different)\r\n      fos_agent: frm.doc.agent,         \r\n\r\n      // child row fields (change fieldnames if needed)\r\n      case: row.case,\r\n      customer: row.customer,\r\n\r\n      // you can also use frm.doc.plan_date instead of now_datetime()\r\n      collection_datetime: frappe.datetime.now_datetime(),\r\n    };\r\n\r\n    // Open New FOS Collection form with the above values filled in\r\n    frappe.new_doc('FOS Collection');\r\n  },\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "FOS Cash Deposit",
  "enabled": 0,
  "modified": "2025-12-10 18:28:41.410717",
  "module": null,
  "name": "FOS Cash Deposit",
  "script": "frappe.ui.form.on(\"FOS Cash Deposit\", {\r\n  refresh(frm) {\r\n    frm.set_query(\"collection\", \"collections\", function () {\r\n      return {\r\n        filters: [\r\n          [\"FOS Collection\", \"is_deposited\", \"!=\", 1],\r\n          [\"FOS Collection\", \"docstatus\", \"=\", 1]\r\n        ]\r\n      };\r\n    });\r\n\r\n    frm.refresh_field(\"collections\");\r\n  }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "FOS Attendance",
  "enabled": 0,
  "modified": "2025-12-10 18:13:48.686143",
  "module": null,
  "name": "FOS Attendance Geolocation",
  "script": "// FOS Attendance â€“ Geolocation handling\r\n\r\n// Helper: update doc fields (lat, lng, geolocation JSON)\r\nfunction set_fos_geo_fields(frm, lat, lng) {\r\n    frm.set_value({\r\n        latitude: lat,\r\n        longitude: lng,\r\n        geolocation: JSON.stringify({\r\n            type: \"FeatureCollection\",\r\n            features: [\r\n                {\r\n                    type: \"Feature\",\r\n                    properties: {},\r\n                    geometry: {\r\n                        type: \"Point\",\r\n                        // GeoJSON = [lng, lat]\r\n                        coordinates: [lng, lat],\r\n                    },\r\n                },\r\n            ],\r\n        }),\r\n    });\r\n}\r\n\r\n// Helper: update map view + marker\r\nfunction set_fos_geo_map(frm, lat, lng) {\r\n    const field = frm.fields_dict.geolocation;\r\n    if (!field || !field.map) return;\r\n\r\n    const map = field.map;\r\n\r\n    // Reuse same marker to avoid adding many markers\r\n    if (frm._fos_geo_marker) {\r\n        frm._fos_geo_marker.setLatLng([lat, lng]);\r\n    } else {\r\n        frm._fos_geo_marker = L.marker([lat, lng]).addTo(map);\r\n    }\r\n\r\n    map.setView([lat, lng], 16); // street-level zoom\r\n}\r\n\r\nfrappe.ui.form.on(\"FOS Attendance\", {\r\n    // When user clicks the button\r\n    fetch_geolocation(frm) {\r\n        if (!navigator.geolocation) {\r\n            frappe.msgprint(__(\"Geolocation is not supported by this browser.\"));\r\n            return;\r\n        }\r\n\r\n        frappe.dom.freeze(__(\"Fetching your geolocation...\"));\r\n\r\n        navigator.geolocation.getCurrentPosition(\r\n            (position) => {\r\n                frappe.dom.unfreeze();\r\n\r\n                const lat = position.coords.latitude;   // e.g. 18.57 (Pune)\r\n                const lng = position.coords.longitude;  // e.g. 73.94\r\n\r\n                // 1) Save values on the document\r\n                set_fos_geo_fields(frm, lat, lng);\r\n\r\n                // 2) Update the map + marker\r\n                set_fos_geo_map(frm, lat, lng);\r\n\r\n                frm.refresh_fields();\r\n            },\r\n            (error) => {\r\n                frappe.dom.unfreeze();\r\n                frappe.msgprint(\r\n                    __(\"Unable to fetch location: \") + error.message\r\n                );\r\n            },\r\n            {\r\n                enableHighAccuracy: true,\r\n                timeout: 10000,\r\n                maximumAge: 0,\r\n            }\r\n        );\r\n    },\r\n\r\n    // When form is opened/refreshed, keep map in sync with saved coords\r\n    refresh(frm) {\r\n        if (\r\n            frm.doc.latitude &&\r\n            frm.doc.longitude\r\n        ) {\r\n            set_fos_geo_map(frm, frm.doc.latitude, frm.doc.longitude);\r\n        }\r\n    },\r\n});\r\n",
  "view": "Form"
 }
]