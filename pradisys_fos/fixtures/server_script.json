[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-10 16:19:39.651453",
  "module": null,
  "name": "FOS Agent Assign",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "FOS Day Plan",
  "script": "# FOS Day Plan – After Submit\n# 1) Link each Case with this Day Plan\n# 2) Mark is_in_day_plan = 1\n# 3) Push visit_date from plan_date (optional)\n# 4) Set Case.agent = row.agent or Day Plan.agent (only if Case.agent is empty)\n \nparent_agent = doc.agent  # Agent on Day Plan header\n \nfor item in (doc.day_plan_items or []):\n    if not item.case:\n        continue\n \n    # --- common updates for every linked Case ---\n    updates = {\n        \"is_in_day_plan\": 1,\n        \"day_plan\": doc.name,\n    }\n \n    # Optional: only if you have this field on FOS Case\n    visit_date = doc.get(\"plan_date\")\n    if visit_date:\n        updates[\"visit_date\"] = visit_date\n \n    # --- Agent assignment logic (your old behavior) ---\n    # Prefer row agent; fallback to parent agent\n    target_agent = item.agent or parent_agent\n \n    if target_agent:\n        # Check current agent on Case\n        current_agent = frappe.db.get_value(\"FOS Case\", item.case, \"agent\")\n \n        # Only assign if Case.agent is empty (don't override)\n        if not current_agent:\n            updates[\"agent\"] = target_agent\n \n    # Apply all updates in one DB call\n    frappe.db.set_value(\"FOS Case\", item.case, updates)",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-10 16:12:51.992275",
  "module": null,
  "name": "FOS Case Permission",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "FOS Case",
  "script": "# Permission Query on FOS Case\r\n# Restrict FOS Agents to only their own linked cases.\r\n\r\n# Variables provided by Frappe:\r\n# - user: current user\r\n# - conditions: existing SQL condition (string or empty)\r\n\r\n# 1) Get roles for the current user\r\nroles = frappe.get_all(\r\n    \"Has Role\",\r\n    filters={\"parent\": user},\r\n    pluck=\"role\"\r\n)\r\n\r\n# 2) Let System Manager and FOS Manager see everything\r\nif \"System Manager\" in roles or \"FOS Manager\" in roles:\r\n    # do not change conditions\r\n    pass\r\nelse:\r\n    # 3) Find the field in FOS Agent that links to User\r\n    meta = frappe.get_meta(\"FOS Agent\")\r\n    user_link_fieldname = None\r\n\r\n    for df in meta.fields:\r\n        if df.fieldtype == \"Link\" and df.options == \"User\":\r\n            user_link_fieldname = df.fieldname\r\n            break\r\n\r\n    # If there is a User link field on FOS Agent, add restriction\r\n    if user_link_fieldname:\r\n        user_escaped = frappe.db.escape(user)\r\n\r\n        new_condition = f\"\"\"\r\n            `tabFOS Case`.`agent` in (\r\n                select name\r\n                from `tabFOS Agent`\r\n                where `{user_link_fieldname}` = {user_escaped}\r\n            )\r\n        \"\"\"\r\n\r\n        # 4) Append / set the condition\r\n        if conditions:\r\n            conditions = f\"({conditions}) and ({new_condition})\"\r\n        else:\r\n            conditions = new_condition\r\n",
  "script_type": "Permission Query"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-10 16:07:33.608504",
  "module": null,
  "name": "FOS Case KYC Status",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "FOS Case",
  "script": "# FOS Case – auto update Status from Outcome Type\r\n\r\n# Make sure we have an outcome\r\nif doc.outcome_type:\r\n    # If visit is completed, mark case as Closed\r\n    if doc.outcome_type == \"Completed\":\r\n        doc.status = \"Closed\"\r\n\r\n    # For any other outcome, keep it Pending\r\n    # (only change if it is not already Closed)\r\n    else:\r\n        if doc.status in (None, \"\", \"Open\", \"Visit Planned\", \"Pending\"):\r\n            doc.status = \"Pending\"\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-10 16:02:50.294155",
  "module": null,
  "name": "FOS Collection Day Plan Link",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "FOS Day Plan",
  "script": "# FOS Collection – before_save\r\n# Auto-link Day Plan from selected Case\r\n\r\nif doc.case and not doc.day_plan:\r\n    doc.day_plan = frappe.db.get_value(\"FOS Case\", doc.case, \"day_plan\")\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Cancel",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-10 15:54:12.269968",
  "module": null,
  "name": "FOS Day plan Cancel",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "FOS Day Plan",
  "script": "# FOS Day Plan – After Cancel\r\n# 1) Remove link to Day Plan from each Case\r\n# 2) Mark is_in_day_plan = 0\r\n# 3) Clear visit_date\r\n# 4) Clear agent IF the Case was linked to THIS Day Plan\r\n\r\nfor item in (doc.day_plan_items or []):\r\n    if not item.case:\r\n        continue\r\n\r\n    # Check which day plan is currently set on the Case\r\n    case_day_plan = frappe.db.get_value(\"FOS Case\", item.case, \"day_plan\")\r\n\r\n    updates = {\r\n        \"is_in_day_plan\": 0,\r\n        \"day_plan\": None,\r\n        \"visit_date\": None,\r\n    }\r\n\r\n    # Only clear agent if this Case was linked to THIS Day Plan\r\n    if case_day_plan == doc.name:\r\n        updates[\"agent\"] = None\r\n\r\n    frappe.db.set_value(\"FOS Case\", item.case, updates)\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-10 15:47:27.479737",
  "module": null,
  "name": "FOS Day Plan",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "FOS Day Plan",
  "script": "# Server Script: FOS Day Plan (After Submit)\r\n\r\nfor item in (doc.day_plan_items or []):\r\n    if not item.case:\r\n        continue\r\n\r\n    # Update Case with Agent + mark that it is in a Day Plan\r\n    update_values = {}\r\n\r\n    if item.agent:\r\n        update_values[\"agent\"] = item.agent  # Link to FOS Agent\r\n\r\n    # 1 = true for Check field\r\n    update_values[\"is_in_day_plan\"] = 1\r\n\r\n    # Optional: if you created a Link field \"day_plan\" on FOS Case\r\n    # update_values[\"day_plan\"] = doc.name\r\n\r\n    if update_values:\r\n        frappe.db.set_value(\"FOS Case\", item.case, update_values)\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-10 15:40:00.461990",
  "module": null,
  "name": "FOS COllection 2",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "FOS Collection",
  "script": "# Update FOS Case + Day Plan Items + Day Plan status AFTER collection is submitted\r\n\r\ndef to_number(val):\r\n    try:\r\n        return float(val or 0)\r\n    except Exception:\r\n        return 0.0\r\n\r\n\r\nif doc.case and doc.amount:\r\n    collection_amount = to_number(doc.amount)\r\n\r\n    if collection_amount <= 0:\r\n        frappe.throw(\"Collection Amount must be greater than zero.\")\r\n\r\n    # ---- 1) Load related Case ----\r\n    case = frappe.get_doc(\"FOS Case\", doc.case)\r\n\r\n    overdue = to_number(case.overdue_amt)\r\n    pending = to_number(case.pending_amount)\r\n\r\n    # Outstanding = Pending if present, else Overdue\r\n    outstanding = pending if pending > 0 else overdue\r\n\r\n    if outstanding > 0:\r\n\r\n        if collection_amount > outstanding:\r\n            frappe.throw(\r\n                f\"Collection Amount {collection_amount} cannot be greater than outstanding {outstanding} for Case {case.name}.\"\r\n            )\r\n\r\n        # ---- 2) Calculate new pending + status on CASE ----\r\n        new_pending = outstanding - collection_amount\r\n        if new_pending > 0:\r\n            new_status = \"Pending\"\r\n        else:\r\n            new_pending = 0\r\n            new_status = \"Closed\"\r\n\r\n        case.db_set(\"pending_amount\", new_pending)\r\n        case.db_set(\"status\", new_status)\r\n\r\n        # ---- 3) Update all Day Plan Items for this Case ----\r\n        day_plan_items = frappe.get_all(\r\n            \"FOS Day Plan Item\",\r\n            filters={\"case\": case.name},\r\n            fields=[\"name\", \"parent\"]\r\n        )\r\n\r\n        parents = set()\r\n\r\n        for row in day_plan_items:\r\n            frappe.db.set_value(\"FOS Day Plan Item\", row.name, {\r\n                \"pending_amount\": new_pending,\r\n                \"status\": new_status,\r\n            })\r\n            if row.parent:\r\n                parents.add(row.parent)\r\n\r\n        # ---- 4) For each related Day Plan, decide new parent status ----\r\n        for parent_name in parents:\r\n            try:\r\n                dp = frappe.get_doc(\"FOS Day Plan\", parent_name)\r\n                rows = [r for r in (dp.day_plan_items or []) if r.case]\r\n\r\n                # if all rows closed -> Completed\r\n                if rows and all((r.status or \"\").strip() == \"Closed\" for r in rows):\r\n                    frappe.db.set_value(\"FOS Day Plan\", parent_name, \"status\", \"Completed\")\r\n                else:\r\n                    # otherwise mark In Progress (unless already Completed/Cancelled)\r\n                    if dp.status in (None, \"\", \"Draft\", \"Planned\"):\r\n                        frappe.db.set_value(\"FOS Day Plan\", parent_name, \"status\", \"In Progress\")\r\n            except Exception:\r\n                pass\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-10 12:15:45.684713",
  "module": null,
  "name": "FOS Cash Deposit",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "FOS Cash Deposit",
  "script": "# On submit of FOS Cash Deposit, mark linked FOS Collections as deposited\r\n\r\nif doc.collections:\r\n    for row in doc.collections:\r\n        if row.collection:\r\n            frappe.db.set_value(\r\n                \"FOS Collection\",\r\n                row.collection,\r\n                \"is_deposited\",\r\n                1\r\n            )\r\n\r\n    frappe.msgprint(\"Selected collections are marked as Deposited.\")\r\n",
  "script_type": "DocType Event"
 }
]